name: Release Creation

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Zip Module
        # Zips current directory, excluding git/github/dev files
        run: |
          zip -r module.zip . -x ".git/*" ".github/*" ".gitignore" "RELEASE_WORKFLOW.md" "task.md" "package.json" "package-lock.json" "node_modules/*" "scripts/utils/*" "scripts/debug_controls_structure.js" "debug_macro.js" "debug_pop.log" "audit_*.json" "audit_*.txt" "audit_*.js" "*.bak" "free_tier_candidates.md" "SETUP_GUIDE.md" "TEST_SCENARIOS.md" "docs/MIGRATION_STRATEGY.md" "docs/GUIDE.md" "sounds/*"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            module.zip
            module.json
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          make_latest: true

      - name: Notify Foundry VTT
        if: success()
        uses: actions/github-script@v7
        env:
          FOUNDRY_TOKEN: ${{ secrets.FOUNDRY_PACKAGE_TOKEN }}
        with:
          script: |
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('module.json', 'utf8'));
            
            const payload = {
              id: manifest.id,
              release: {
                version: manifest.version,
                manifest: `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/latest/download/module.json`,
                notes: `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/v${manifest.version}`,
                compatibility: manifest.compatibility
              }
            };
            
            console.log("Sending payload:", JSON.stringify(payload, null, 2));
            
            const response = await fetch("https://foundryvtt.com/_api/packages/release_version/", {
              method: "POST",
              headers: {
                'Content-Type': 'application/json',
                'Authorization': process.env.FOUNDRY_TOKEN
              },
              body: JSON.stringify(payload)
            });
            
            const text = await response.text();
            let data;
            try {
              data = JSON.parse(text);
            } catch {
              data = text;
            }
            console.log("Response:", typeof data === 'string' ? data : JSON.stringify(data, null, 2));
            
            if (!response.ok) {
              core.setFailed(`Foundry API Error (${response.status}): ${typeof data === 'string' ? data : JSON.stringify(data)}`);
            } else {
              console.log("Foundry VTT notified successfully.");
            }
